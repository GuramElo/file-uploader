<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure File Uploader</title>
    <link
            href="https://releases.transloadit.com/uppy/v3.13.0/uppy.min.css"
            rel="stylesheet"
    />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h2 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status {
            text-align: center;
            padding: 12px 20px;
            margin: 20px auto;
            border-radius: 8px;
            font-size: 14px;
            max-width: 800px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status.healthy {
            background: linear-gradient(135deg, #0f5132 0%, #198754 100%);
            border: 1px solid #0f5132;
        }

        .status.checking {
            background: linear-gradient(135deg, #664d03 0%, #ffc107 100%);
            border: 1px solid #664d03;
            color: #000;
        }

        .status.error {
            background: linear-gradient(135deg, #842029 0%, #dc3545 100%);
            border: 1px solid #842029;
        }

        .info {
            background: rgba(30, 58, 95, 0.6);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            margin: 20px auto;
            font-size: 14px;
            max-width: 800px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .info strong {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
            color: #667eea;
        }

        .info ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .info li {
            margin: 8px 0;
            line-height: 1.6;
        }

        #drag-drop-area {
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            h2 {
                font-size: 1.5em;
            }

            .info, .status {
                font-size: 13px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h2>üöÄ Secure File Uploader</h2>

    <div id="status" class="status checking">
        <span class="spinner"></span>
        <span>Checking server status...</span>
    </div>

    <div class="info">
        <strong>üìã Upload Information:</strong>
        <ul>
            <li>‚úÖ Maximum file size: <strong>10GB</strong> per file</li>
            <li>üîÑ Uploads are <strong>resumable</strong> - pause and continue anytime</li>
            <li>üîí Files are encrypted during transfer</li>
            <li>üíæ Upload progress is saved automatically</li>
            <li>‚ö° Multiple files can be uploaded simultaneously</li>
            <li>üåç Unicode filenames (Georgian, Chinese, etc.) are supported</li>
        </ul>
    </div>

    <div id="drag-drop-area"></div>

    <div class="footer">
        Powered by TUS Protocol ‚Ä¢ Docker ‚Ä¢ Nginx ‚Ä¢ Cloudflare Tunnel Ready
    </div>
</div>

<script src="https://releases.transloadit.com/uppy/v3.13.0/uppy.min.js"></script>

<script type="module">
    const { Uppy, Dashboard, Tus } = window.Uppy;

    const protocol = window.location.protocol;
    const hostname = window.location.hostname;
    const port = window.location.port;
    const serverUrl = `${protocol}//${hostname}${port ? ':' + port : ''}`;

    console.log('üöÄ File Uploader initialized');
    console.log('üìç Server URL:', serverUrl);

    async function checkServerHealth() {
        const statusEl = document.getElementById('status');
        try {
            const response = await fetch(`${serverUrl}/health`);
            const health = await response.json();

            if (health.status === 'healthy') {
                statusEl.className = 'status healthy';
                statusEl.innerHTML = `‚úÖ Server is healthy - <strong>${health.disk.free}</strong> free space available`;
            } else {
                statusEl.className = 'status error';
                statusEl.innerHTML = `‚ö†Ô∏è Server is degraded - Low disk space`;
            }
        } catch (error) {
            statusEl.className = 'status error';
            statusEl.innerHTML = `‚ùå Cannot connect to server`;
            console.error('Health check failed:', error);
        }
    }

    checkServerHealth();
    setInterval(checkServerHealth, 30000);

    const uppy = new Uppy({
        id: 'uppy',
        autoProceed: false,
        debug: true,
        restrictions: {
            maxFileSize: 10 * 1024 * 1024 * 1024,
            maxNumberOfFiles: 10,
            minNumberOfFiles: null,
        },
    })
        .use(Dashboard, {
            inline: true,
            target: '#drag-drop-area',
            theme: 'dark',
            showProgressDetails: true,
            proudlyDisplayPoweredByUppy: false,
            note: 'Drag and drop files here, or click to browse',
            height: 470,
            metaFields: [
                { id: 'name', name: 'Name', placeholder: 'File name' },
            ],
            browserBackButtonClose: true,
        })
        .use(Tus, {
            endpoint: `${serverUrl}/files`,
            retryDelays: [0, 1000, 3000, 5000, 10000],
            chunkSize: 5 * 1024 * 1024,
            limit: 1, // Only 1 concurrent request per file (was 3)
            parallelUploads: 1, // Only 1 file at a time
        });

    uppy.on('file-added', (file) => {
        console.log('‚úÖ File added:', file.name, `(${(file.size / 1024 / 1024).toFixed(2)}MB)`);
    });

    uppy.on('upload', (data) => {
        console.log('üöÄ Starting upload...', data);
    });

    uppy.on('upload-progress', (file, progress) => {
        const percent = ((progress.bytesUploaded / progress.bytesTotal) * 100).toFixed(1);
        if (progress.bytesUploaded % (10 * 1024 * 1024) < (5 * 1024 * 1024)) {
            console.log(`üìä Progress [${file.name}]: ${percent}% (${(progress.bytesUploaded / 1024 / 1024).toFixed(1)}MB / ${(progress.bytesTotal / 1024 / 1024).toFixed(1)}MB)`);
        }
    });

    uppy.on('upload-success', (file, response) => {
        console.log('‚úÖ Upload successful:', file.name);
    });

    uppy.on('upload-error', (file, error, response) => {
        console.error('‚ùå Upload error:', file?.name, error);
        console.error('Response:', response);
    });

    uppy.on('retry-all', (fileIDs) => {
        console.log('üîÑ Retrying uploads:', fileIDs);
    });

    uppy.on('complete', (result) => {
        if (result.successful.length > 0) {
            console.log('‚úÖ Successfully uploaded:', result.successful.map(f => f.name).join(', '));
            uppy.info(`‚úÖ Successfully uploaded ${result.successful.length} file(s)`, 'success', 5000);
        }

        if (result.failed.length > 0) {
            console.log('‚ùå Failed uploads:', result.failed.map(f => f.name).join(', '));
            uppy.info(`‚ùå Failed to upload ${result.failed.length} file(s)`, 'error', 5000);
        }

        checkServerHealth();
    });

    window.addEventListener('beforeunload', (e) => {
        const inProgress = uppy.getFiles().some(file =>
            file.progress && file.progress.uploadStarted && !file.progress.uploadComplete
        );

        if (inProgress) {
            e.preventDefault();
            e.returnValue = 'Uploads are in progress. Are you sure you want to leave?';
            return e.returnValue;
        }
    });

    console.log('‚úÖ Uppy ready for uploads');
</script>
</body>
</html>